<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat IA Premium Â· ConversaciÃ³n Guiada</title>
<style>
  :root{
    --bg:#0f172a; --card:#0b1220; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8;
    --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --blue:#1d4ed8; --line:#1f2a44;
    --bubble:#142034; --you:#173763; --shadow:0 12px 32px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow)}
  .header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .title{display:flex;gap:10px;align-items:center;font-weight:800}
  .flags{font-size:22px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  select,button,input[type="range"],input[type="text"]{background:var(--card);color:var(--ink);border:1px solid var(--line);border-radius:12px;padding:10px 12px}
  select{min-width:180px}
  .board{margin-top:12px;padding:10px}
  .stream{display:flex;flex-direction:column;gap:10px;height:58vh;overflow:auto;padding:10px;background:var(--card);border:1px solid var(--line);border-radius:16px}
  .msg{max-width:85%;padding:10px 12px;border-radius:14px;line-height:1.4;white-space:pre-wrap;word-wrap:break-word}
  .msg.user{background:var(--you);align-self:flex-end}
  .msg.bot{background:var(--bubble);align-self:flex-start}
  .feedback{border-left:3px solid var(--ok);background:#0f1f2f;padding:8px 10px;border-radius:12px}
  .row{display:flex;gap:10px;align-items:center;margin-top:10px}
  .composer{display:flex;gap:8px;margin-top:12px}
  .input{flex:1}
  .btn{background:var(--blue);border:1px solid var(--blue);color:#fff;border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:700}
  .btn.ghost{background:var(--card);color:var(--ink);border-color:var(--line)}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  .meters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .meter{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-size:12px;color:var(--muted)}
  .error{margin-top:8px;color:#fca5a5;font-size:13px}
  @media (max-width:640px){ .controls{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="wrap">
  <section class="card header">
    <div class="title"><span class="flags">ğŸ‡ºğŸ‡¸</span> Chat IA Premium Â· ConversaciÃ³n Guiada <span class="flags">ğŸ‡ªğŸ‡¸</span></div>
    <div class="controls">
      <select id="level" title="Nivel">
        <option value="beginner" selected>Beginner</option>
        <option value="intermediate">Intermediate</option>
        <option value="advanced">Advanced</option>
      </select>
      <select id="topic" title="Tema">
        <option value="greetings" selected>ğŸ‘‹ Greetings & Introductions</option>
        <option value="daily">ğŸ•’ Daily Routines</option>
        <option value="restaurant">ğŸ½ï¸ Restaurant & CafÃ©</option>
        <option value="shopping">ğŸ›ï¸ Shopping</option>
        <option value="travel">âœˆï¸ Travel & Airport</option>
        <option value="work">ğŸ’¼ Work & Interview</option>
        <option value="doctor">ğŸ¥ Doctor</option>
        <option value="phone">ğŸ“ Phone Calls</option>
        <option value="vacation">ğŸ–ï¸ Vacations & Free Time</option>
        <option value="opinions">ğŸ§  Small Talk & Opinions</option>
      </select>
      <button id="resetBtn" class="btn ghost" type="button">ğŸ§¹ Reset</button>
    </div>
  </section>

  <section class="card board">
    <div class="meters">
      <div id="statTurns" class="meter">Turns: 0</div>
      <div id="statScore" class="meter">Last score: â€”</div>
      <div id="ttsState" class="meter">TTS: ready</div>
      <div id="sttState" class="meter">Mic: â€”</div>
    </div>
    <div id="stream" class="stream" aria-live="polite"></div>

    <div class="composer">
      <input id="input" class="input" type="text" placeholder="Type your message in Englishâ€¦ (Enter to send)" />
      <button id="micBtn" class="btn ghost" type="button" title="Speak">ğŸ¤</button>
      <button id="listenBtn" class="btn ghost" type="button" title="Listen last bot message">ğŸ”Š</button>
      <button id="sendBtn" class="btn" type="button">Send</button>
    </div>
    <div class="row small">TTS rate <input id="rate" type="range" min="0.6" max="1.4" step="0.1" value="1"/> Â· Voice: <select id="voiceSel"></select></div>
    <div id="err" class="error" role="status" aria-live="polite"></div>
  </section>
</div>

<script>
  // CambiÃ¡ este dominio si usÃ¡s otro en Vercel (Settings â†’ Domains)
  const BACKEND_URL = "https://englishchat-backend.vercel.app/api/englishchat";

  const $ = (id)=>document.getElementById(id);
  const stream = $("stream");
  const input = $("input");
  const sendBtn = $("sendBtn");
  const listenBtn = $("listenBtn");
  const micBtn = $("micBtn");
  const resetBtn = $("resetBtn");
  const topicSel = $("topic");
  const levelSel = $("level");
  const statTurns = $("statTurns");
  const statScore = $("statScore");
  const ttsState = $("ttsState");
  const sttState = $("sttState");
  const errBox = $("err");
  const rate = $("rate");
  const voiceSel = $("voiceSel");

  let history = [];
  let turns = 0;
  let lastBot = '';

  // UI helpers
  function add(role, text, feedback){
    const bubble = document.createElement('div');
    bubble.className = 'msg ' + (role==='user'?'user':'bot');
    bubble.textContent = text;
    stream.appendChild(bubble);
    if(feedback && (feedback.grammar || feedback.alt)){
      const fb = document.createElement('div');
      fb.className = 'feedback small';
      fb.innerHTML = `<strong>Feedback</strong><br>${feedback.grammar||''}${feedback.grammar&&feedback.alt?'<br>':''}<em>${feedback.alt||''}</em>`;
      stream.appendChild(fb);
    }
    stream.parentElement.scrollTop = stream.parentElement.scrollHeight;
  }
  function busy(v){ sendBtn.disabled=v; input.disabled=v; micBtn.disabled=v; listenBtn.disabled=v; }

  // ===== Speech Synthesis (TTS) =====
  let voices = [];
  function loadVoices(){
    voices = speechSynthesis.getVoices().filter(v=>/en-|English/i.test(v.lang));
    voiceSel.innerHTML = voices.map((v,i)=>`<option value="${i}">${v.name} (${v.lang})</option>`).join('');
    if(!voices.length){ ttsState.textContent = 'TTS: not available'; }
  }
  if('speechSynthesis' in window){
    window.speechSynthesis.onvoiceschanged = loadVoices; loadVoices();
  } else { ttsState.textContent = 'TTS: not supported'; }

  function speak(text){
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    const v = voices[voiceSel.selectedIndex] || voices[0];
    if(v) u.voice = v; u.rate = parseFloat(rate.value||'1');
    speechSynthesis.cancel(); speechSynthesis.speak(u);
  }
  listenBtn.addEventListener('click', ()=>{ if(lastBot) speak(lastBot); });

  // ===== Speech Recognition (STT) =====
  let rec; let sttSupported = false;
  if('webkitSpeechRecognition' in window){
    const R = window.webkitSpeechRecognition;
    rec = new R(); rec.lang = 'en-US'; rec.continuous = false; rec.interimResults = false; sttSupported = true;
    sttState.textContent = 'Mic: ready';
    rec.onresult = (e)=>{ const t = e.results[0][0].transcript; input.value = t; send(); };
    rec.onerror = ()=>{ sttState.textContent = 'Mic: error'; };
    rec.onend = ()=>{ micBtn.textContent='ğŸ¤'; sttState.textContent='Mic: ready'; };
  } else {
    sttState.textContent = 'Mic: not supported';
  }
  micBtn.addEventListener('click', ()=>{
    if(!sttSupported){ errBox.textContent = 'El micrÃ³fono no es compatible en este navegador. Usa Chrome en Android/Windows.'; return; }
    errBox.textContent = '';
    try{ micBtn.textContent = 'âºï¸'; rec.start(); sttState.textContent = 'Mic: listeningâ€¦'; }
    catch(_){ sttState.textContent = 'Mic: permission?'; }
  });

  // ===== Send to backend =====
  async function send(){
    const text = input.value.trim();
    if(!text) return;
    input.value=''; errBox.textContent='';
    add('user', text);
    busy(true);

    // recortar contexto segÃºn nivel para optimizar tokens
    const keep = levelSel.value==='advanced' ? 10 : (levelSel.value==='intermediate'? 8 : 6);
    history.push({role:'user', content:text});
    history = history.slice(-keep);

    try{
      const res = await fetch(BACKEND_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          topic: topicSel.value,
          level: levelSel.value,
          history
        })
      });
      const data = await res.json();
      if(!res.ok){
        const detail = data?.detail || JSON.stringify(data);
        add('bot','âš ï¸ Provider error.');
        errBox.textContent = detail;
      } else {
        const reply = String(data.reply || 'â€¦');
        lastBot = reply;
        add('bot', reply, {grammar:data.grammar, alt:data.alt});
        if(data.score!=null){ statScore.textContent = 'Last score: ' + data.score; }
        if('speechSynthesis' in window) speak(reply);
        history.push({role:'assistant', content: reply});
        history = history.slice(-keep);
        turns++; statTurns.textContent = 'Turns: ' + turns;
      }
    }catch(e){
      add('bot','âš ï¸ ConexiÃ³n fallida.');
      errBox.textContent = e?.message || String(e);
    }finally{
      busy(false); input.focus();
    }
  }

  sendBtn.addEventListener('click', send);
  input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});
  resetBtn.addEventListener('click', ()=>{
    history=[]; turns=0; statTurns.textContent='Turns: 0'; statScore.textContent='Last score: â€”';
    stream.innerHTML=''; add('bot','Hi! Choose a topic and level, then start typing or tap the mic.');
  });

  // Mensaje inicial
  add('bot','Hi! Choose a topic and level, then start typing or tap the mic.');
</script>
</body>
</html>
