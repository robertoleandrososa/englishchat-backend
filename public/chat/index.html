<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Free Conversation ¬∑ Chat IA</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9aa5b1;
    --blue:#2563eb; --line:#1f2a44; --bubble:#142034; --you:#173763;
    --shadow:0 10px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
    font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .header{display:flex;align-items:center;gap:10px;background:var(--card);
    border-radius:16px;padding:14px 16px;box-shadow:var(--shadow)}
  .title{font-weight:800;letter-spacing:.2px}
  .muted{color:var(--muted);font-size:13px}
  .board{margin-top:12px;background:#0b1220;border:1px solid var(--line);
    border-radius:16px;box-shadow:var(--shadow);padding:10px;height:60vh;overflow:auto}
  .msg{max-width:85%;padding:10px 12px;border-radius:14px;line-height:1.38;
    white-space:pre-wrap;word-wrap:break-word}
  .msg.user{background:var(--you);align-self:flex-end}
  .msg.bot{background:var(--bubble);align-self:flex-start}
  .stream{display:flex;flex-direction:column;gap:10px}
  .composer{display:flex;gap:8px;margin-top:12px}
  .input{flex:1;background:#0b1220;border:1px solid var(--line);
    border-radius:12px;color:var(--ink);padding:12px}
  button{background:var(--blue);border:1px solid var(--blue);color:#fff;
    border-radius:12px;padding:12px 14px;cursor:pointer;font-weight:600}
  button[disabled]{opacity:.6;cursor:not-allowed}
  .row{display:flex;gap:10px;align-items:center;margin-top:10px}
  .select{background:#0b1220;border:1px solid var(--line);color:var(--ink);
    border-radius:10px;padding:8px}
  .error{margin-top:8px;color:#fca5a5;font-size:13px}
  @media (max-width:560px){
    .header{flex-direction:column;align-items:flex-start}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">üó£Ô∏è Free Conversation ¬∑ Conversaci√≥n Libre</div>
      <div class="muted">Pr√°ctica guiada: el bot corrige y sugiere alternativas.</div>
    </div>

    <div class="row">
      <label class="muted">Tema</label>
      <select id="topic" class="select">
        <option value="travel" selected>Travel</option>
        <option value="work">Work</option>
        <option value="family">Family</option>
        <option value="shopping">Shopping</option>
        <option value="food">Food</option>
      </select>
      <button id="resetBtn" type="button">Reset</button>
    </div>

    <div class="board">
      <div id="stream" class="stream"></div>
    </div>

    <div class="composer">
      <input id="input" class="input" type="text"
             placeholder="Escribe en ingl√©s‚Ä¶ (Enter para enviar)" />
      <button id="sendBtn" type="button">Send</button>
    </div>
    <div id="err" class="error" role="status" aria-live="polite"></div>
  </div>

<script>
  // üîó Cambia solo si usas otro dominio principal en Vercel
  const BACKEND_URL = "https://englishchat-backend.vercel.app/api/englishchat";

  const $ = (id) => document.getElementById(id);
  const stream = $("stream");
  const input = $("input");
  const sendBtn = $("sendBtn");
  const resetBtn = $("resetBtn");
  const errBox = $("err");
  const topicSel = $("topic");

  /** Historial m√≠nimo para enviar contexto */
  let history = [];

  function add(role, text){
    const div = document.createElement("div");
    div.className = "msg " + (role === "user" ? "user" : "bot");
    div.textContent = text;
    stream.appendChild(div);
    stream.parentElement.scrollTop = stream.parentElement.scrollHeight;
  }

  function setBusy(b){
    sendBtn.disabled = b;
    input.disabled = b;
  }

  async function send(){
    const text = input.value.trim();
    if(!text) return;
    input.value = "";
    errBox.textContent = "";
    add("user", text);
    setBusy(true);

    try{
      // mantenemos 6 √∫ltimos turnos como contexto liviano
      history.push({role:"user", content:text});
      history = history.slice(-6);

      const r = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          topic: topicSel.value,
          history
        })
      });

      const data = await r.json();
      if(!r.ok){
        add("bot", "‚ö†Ô∏è Error del servidor.");
        errBox.textContent = data?.detail || JSON.stringify(data);
      }else{
        const reply = data?.reply || "‚Ä¶";
        add("bot", reply);
        history.push({role:"assistant", content: reply});
        history = history.slice(-6);
      }
    }catch(e){
      add("bot","‚ö†Ô∏è Conexi√≥n fallida.");
      errBox.textContent = e?.message || String(e);
    }finally{
      setBusy(false);
      input.focus();
    }
  }

  // UI events
  sendBtn.addEventListener("click", send);
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); }
  });
  resetBtn.addEventListener("click", ()=>{
    history = [];
    stream.innerHTML = "";
    errBox.textContent = "";
    add("bot", "Hi! Let's practice. Choose a topic and type a message.");
  });

  // Mensaje inicial
  add("bot", "Hi! Let's practice. Choose a topic and type a message.");
</script>
</body>
</html>
